<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <title>综合信息发布</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
    <link rel="stylesheet" href="css/overviewInfo.css">
</head>
<body>
<div class="title">
    <img class="title-img" src="./images/top_title3@2x.png" alt="">
    <div class="time-sign">
        <p><span class="current-time">2020年5月23日 星期六</span> <span class="today-weather">晴天</span></p>
        <p class="level-explain">
            <span >保障等级: <b class="bzdj"></b></span>
            <span >运行图: <b class="Yxth"></b></span>
        </p>
    </div>
</div>
<div class="table-box">
    <div class="item">
        <div class="item-title">计划<br/> 施工<br/> 情况</div>
        <div class="item-content">
            <table class="table-title">
                <thead>
                <tr>
                    <th width="5%">序号</th>
                    <th width="10%">施工编号</th>
                    <th width="10%">施工时间</th>
                    <th width="7.5%">施工单位</th>
                    <th width="12.5%">施工地点</th>
                    <th width="10%">施工内容</th>
                    <th width="10%">是否停电</th>
                    <th width="10%">是否封锁</th>
                    <th width="25%" >目前情况</th>
                </tr>
                </thead>
            </table>
            <div id="planTable" class="table-body">
                <table>
                    <thead>
                    <tr>
                        <th width="5%">序号</th>
                        <th width="10%">施工编号</th>
                        <th width="10%">施工时间</th>
                        <th width="7.5%">施工单位</th>
                        <th width="12.5%">施工地点</th>
                        <th width="10%">施工内容</th>
                        <th width="10%">是否停电</th>
                        <th width="10%">是否封锁</th>
                        <th width="25%" >目前情况</th>
                    </tr>
                    </thead>
                    <tbody id="planBody">
                  <!--      <tr>
                            <td>1</td>
                            <td>0401</td>
                            <td>2020-05-01</td>
                            <td><div>成都</div></td>
                            <td><div>成都</div></td>
                            <td><div>这是事故内容</div></td>
                            <td><span class="yes">是</span></td>
                            <td><span>是</span></td>
                            <td><div class="comment">TTTTTTTTTT</div></td>
                        </tr>-->
                    </tbody>
                </table>
                <div class="no-data">暂无数据</div>
            </div>
        </div>
    </div>
    <div class="item">
        <div class="item-title">日常<br/> 及<br/> 临时<br/> 施工<br/> 情况</div>
        <div class="item-content">
            <table class="table-title">
                <thead>
                <tr>
                    <th width="5%">序号</th>
                    <th width="10%">施工编号</th>
                    <th width="10%">施工时间</th>
                    <th width="7.5%">施工单位</th>
                    <th width="12.5%">施工地点</th>
                    <th width="10%">施工内容</th>
                    <th width="10%">是否停电</th>
                    <th width="10%">是否封锁</th>
                    <th width="25%" >目前情况</th>
                </tr>
                </thead>
            </table>
            <div id="commonTable" class="table-body" >
                <table>
                    <thead>
                    <tr>
                        <th width="5%">序号</th>
                        <th width="10%">施工编号</th>
                        <th width="10%">施工时间</th>
                        <th width="7.5%">施工单位</th>
                        <th width="12.5%">施工地点</th>
                        <th width="10%">施工内容</th>
                        <th width="10%">是否停电</th>
                        <th width="10%">是否封锁</th>
                        <th width="25%" >目前情况</th>
                    </tr>
                    </thead>
                    <tbody id="commonBody">

                    </tbody>
                </table>
                <div class="no-data">暂无数据</div>
            </div>
        </div>
    </div>
    <div class="item">
        <div class="item-title">调车<br/> 及<br/> 洗车 <br/>作业 <br/>情况</div>
        <div class="item-content">
            <table class="table-title">
                <thead>
                <tr>
                    <th width="5%">序号</th>
                    <th width="7.5%">调车编号</th>
                    <th width="10%">车号</th>
                    <th width="10%">自行走</th>
                    <th width="12.5%">非自行走</th>
                    <th width="10%">起始股值</th>
                    <th width="10%">调入股值</th>
                    <th width="30%" >目前情况</th>
                </tr>
                </thead>
            </table>
            <div id="washTable" class="table-body" >
                <table>
                    <thead>
                    <tr>
                        <th width="5%">序号</th>
                        <th width="7.5%">调车编号</th>
                        <th width="10%">车号</th>
                        <th width="10%">自行走</th>
                        <th width="12.5%">非自行走</th>
                        <th width="10%">起始股值</th>
                        <th width="10%">调入股值</th>
                        <th width="30%" >目前情况</th>
                    </tr>
                    </thead>
                    <tbody id="washBody">
                        <tr>
                            <td>1</td>
                            <td>0401</td>
                            <td>2020-05-01</td>
                            <td><div>成都</div></td>
                            <td><div>成都</div></td>
                            <td><div>这是事故内容</div></td>
                            <td><span class="yes">是</span></td>
                            <td>xxxxxx</td>
                        </tr>
                    </tbody>
                </table>
                <div class="no-data">暂无数据</div>
            </div>

        </div>
    </div>
</div>
</body>
<script src="js/jquery.min.js"></script>
<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/common.js"></script>
<script>
    var timer=null;
    var ws=null;//WebSocket实例
    var GetMoveAndWashTrainDataFlag=true;//默认加载日常及临时施工数据
    var GetStationTrackAndTrainInfoDataFlag=true;//默认加载调车及洗车数据
    $(function () {
        /***********隐藏滚动条***********/
        $("#planTable").mCustomScrollbar({
            theme:"minimal"
        });
        $("#commonTable").mCustomScrollbar({
            theme:"minimal"
        });
        $("#washTable").mCustomScrollbar({
            theme:"minimal"
        });
        let h = window.innerHeight;
        let w = 120;
        if (window.innerWidth < 1920) {
            if (window.innerWidth == 1600) {
                w = 100
            } else if (window.innerWidth == 1440) {
                w = 90
            } else if (window.innerWidth == 1366) {
                w = 85
            }
        }
        let boxH=Number.parseInt((h - w - 200 )/3)

        $("#planTable").css('height',boxH+'px')
        $("#commonTable").css('height',boxH+'px')
        $("#washTable").css('height',boxH+'px')

        addWebSocket();//默认执行第一次
        timer=setInterval(function () {//根据状态判断时候重新建立连接
            if(ws.readyState!=1){//未连接
                addWebSocket()
            }
        },1000)
        let receiveMsg=[
            {
                "buildNo": "SG-001",
                "buildDate": "2020-06-05 09:12:12",
                "buildUnit": "检修一组",
                "buildAddress": "L-3A,L-3B,L-4A,L-4B",
                "buildContent": "股道维护",
                "isPowerCut": "是",
                "isBlockade": "是",
                "currentSituation": "请点确认中"
            },
            {
                "buildNo": "SG-002",
                "buildDate": "2020-06-05 09:12:12",
                "buildUnit": "检修二组",
                "buildAddress": "L-5A,L-5B",
                "buildContent": "股道维护",
                "isPowerCut": "否",
                "isBlockade": "否",
                "currentSituation": "已开工"
            },
            {
                "buildNo": "SG-001",
                "buildDate": "2020-06-05 09:12:12",
                "buildUnit": "检修一组",
                "buildAddress": "L-3A,L-3B,L-4A,L-4B",
                "buildContent": "股道维护",
                "isPowerCut": "是",
                "isBlockade": "是",
                "currentSituation": "请点确认中"
            },
            {
                "buildNo": "SG-002",
                "buildDate": "2020-06-05 09:12:12",
                "buildUnit": "检修二组",
                "buildAddress": "L-5A,L-5B",
                "buildContent": "股道维护",
                "isPowerCut": "否",
                "isBlockade": "否",
                "currentSituation": "已开工"
            }
        ]

        bindData(JSON.stringify(receiveMsg),0)
        bindData(JSON.stringify(receiveMsg),1)
        let testArr=[
            {
                "moveNo": "DC-001",
                "trainNo": "0401",
                "oneSelfMove": "√",
                "noOneSelfMove": null,
                "startStationTrack": "L-5A",
                "endStationTrack": "L-8A",
                "currentSituation": "请点确认中"
            },
            {
                "moveNo": "XC-002",
                "trainNo": "0402",
                "oneSelfMove": null,
                "noOneSelfMove": "G04103",
                "startStationTrack": "L-7A",
                "endStationTrack": "L-13B",
                "currentSituation": "销点确认中"
            },
            {
                "moveNo": "DC-001",
                "trainNo": "0401",
                "oneSelfMove": "√",
                "noOneSelfMove": null,
                "startStationTrack": "L-5A",
                "endStationTrack": "L-8A",
                "currentSituation": "请点确认中"
            },
            {
                "moveNo": "XC-002",
                "trainNo": "0402",
                "oneSelfMove": null,
                "noOneSelfMove": "G04103",
                "startStationTrack": "L-7A",
                "endStationTrack": "L-13B",
                "currentSituation": "销点确认中"
            }
        ]
        washCommonData(JSON.stringify(testArr))
    })


    function addWebSocket(obj,type) {
         ws = new WebSocket("ws://localhost:8080/DTCGCW/ZhWebSocket.ws?cdid="+cdidx+'connectType=1');
        let receiveMsg='';
         ws.onopen = function(){//连接成功
            ws.send('{\'head\':\'GetPlanBuildData\',message:\'\'}')  //得到计划施工数据
        };

        ws.onmessage = function(evt) {//接收数据
            console.log( "Received Message: " + evt.data);

            if(evt.data==='开始'){
                receiveMsg=''
            }
            if(evt.data.indexOf('结束')>-1){
                $(".no-data").css("display","none")
                $("#planTable table,#commonTable table,#washTable table").css("display","block")
                let headStr=evt.data.split('结束:')[1]
                if(headStr=='GetPlanBuildData'){
                    bindData(receiveMsg,0)
                    if(GetMoveAndWashTrainDataFlag){//默认加载
                        ws.send('{\'head\':\'GetMoveAndWashTrainData\',message:\'\'}')  //得到日常及临时施工数据
                    }

                }else if(headStr=='GetMoveAndWashTrainData'){
                    bindData(receiveMsg,1)
                    if(GetStationTrackAndTrainInfoDataFlag){
                        ws.send('{\'head\':\'GetStationTrackAndTrainInfoData\',message:\'\'}')  //得到调车及洗车数据
                    }

                }else if(headStr=='GetStationTrackAndTrainInfoData'){
                    washCommonData(receiveMsg)
                }

            }else{
                receiveMsg +=evt.data;
            }
        };

        ws.onclose = function(evt) {
        };
        ws.onerror = function () {
            $(".no-data").css("display","block")
            $("#planTable table,#commonTable table,#washTable table").css("display","none")
        };
    }
    function bindData(str,type) {
        let arr=JSON.parse(str)
        let tableStr=''
        for (let i=0;i<arr.length;i++){
            let className=''
            let classNameTwo=''
            if(arr[i].isPowerCut==='是'){
                className='yes'
            }
            if(arr[i].isBlockade==='是'){
                classNameTwo='yes'
            }
            tableStr+=`<tr>
                           <td>${i+1}</td>
                           <td>${arr[i].buildNo?arr[i].buildNo:''}</td>
                           <td>${arr[i].buildDate?arr[i].buildDate:''}</td>
                           <td>${arr[i].buildUnit?arr[i].buildUnit:''}</td>
                           <td><div class="time">${arr[i].buildAddress?arr[i].buildAddress:''}</div></td>
                           <td><div class="time">${arr[i].buildContent?arr[i].buildContent:''}</div></td>
                             <td><span class=${className}>${arr[i].isPowerCut}</span></td>
                             <td><span class=${classNameTwo}>${arr[i].isBlockade}</span></td>
                           <td >
                               <a class="comment">${arr[i].currentSituation?arr[i].currentSituation:''}</a>
                           </td>
                       </tr>`
        }
        if(type==0){
            $("#planBody").html(tableStr)
        }else if(type==1){
            $("#commonBody").html(tableStr)
            GetMoveAndWashTrainDataFlag=false
        }
    }

    function washCommonData(str) {//调车及洗车
        let arr=JSON.parse(str)
        let tableStr=''
        for (let i=0;i<arr.length;i++){
            console.log(arr[i].moveNo)
            tableStr+=`<tr>
                           <td>${i+1}</td>
                           <td>${arr[i].moveNo?arr[i].moveNo:''}</td>
                           <td>${arr[i].trainNo?arr[i].trainNo:''}</td>
                           <td>${arr[i].oneSelfMove?arr[i].oneSelfMove:''}</td>
                           <td>${arr[i].noOneSelfMove?arr[i].noOneSelfMove:''}</td>
                           <td>${arr[i].startStationTrack?arr[i].startStationTrack:''}</td>
                           <td>${arr[i].endStationTrack?arr[i].endStationTrack:''}</td>
                           <td><a class='comment'>${arr[i].currentSituation?arr[i].currentSituation:''}</a></td>
                       </tr>`
        }
        $("#washBody").html(tableStr)
        GetStationTrackAndTrainInfoDataFlag=true
    }

</script>
</html>
